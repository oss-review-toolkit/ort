/*
 * Copyright (C) 2024 The ORT Project Authors (see <https://github.com/oss-review-toolkit/ort/blob/main/NOTICE>)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * License-Filename: LICENSE
 */

package org.ossreviewtoolkit.plugins.scanners.scanoss

import com.scanoss.Winnowing

import io.kotest.core.TestConfiguration
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe

import org.ossreviewtoolkit.utils.test.getResource

private val winnowing = Winnowing.builder().build()

private fun TestConfiguration.wfpForResource(name: String, binFile: Boolean = false) =
    winnowing.wfpForContents(name.substringAfterLast('/'), binFile, getResource(name).readBytes())

class WinnowingTest : StringSpec({
    "The fingerprint should be calculated correctly for the Apache-2.0 license text" {
        wfpForResource("/wfp/Apache-2.0.license") shouldBe """
            file=e3fc50a88d0a364313df4b21ef20c29e,11357,Apache-2.0.license
            5=33193f1b,1716113f,0c557e09
            9=643a45ae,2ae8e84a,bacd17ac
            10=c54959e6,c8c4ada9
            12=095e9c9e,10754b25
            13=8de4c91b
            15=1906f673,b70c2c99
            17=82844dcf,9d75ed8c
            18=e09ca533,163fd100,e3ab20a5
            19=9aa08fa2
            20=dfb7c8e2
            21=62a267bf,89999f72
            23=fa77a2c6
            24=780b3e93
            26=f9722399,cad7579b,a73214cc,a3cd5e97
            28=08f2243a
            30=0fad4d4c,0ed8d3be
            32=dd22b5a4,97fc9200
            35=cdb44ffc,78a155f0
            36=4d1ab0e2
            37=6a9de676,a8ec6cfd
            38=c9befb24
            40=6e2db6c0
            41=ebbea868,46493752
            42=0f422343
            43=075081b0
            44=42d0762e,7440b7b9,63517188
            45=165b2ad4,edf3c34c
            46=e1c66bc4
            48=622f4a87
            49=cd74d072,a4b7a885,91d65b18
            50=78292613
            51=b4ef74e6
            52=2aaf3e45,6fe9ce24,f96a3d30
            53=21c17277
            54=d40c1035,60aff2a9
            55=7f733a47,9344b1df,eb9357ec,e51a39b1,09460717
            56=8ad000d9,c785f8e6,e4532416
            57=5e702dd7
            58=2f6e9882,7a964a06,708b34c0
            59=188207f5,d4c28400
            60=f4758426,9a99d40c
            62=996ce703,e24cad4b
            63=3fe90b35,85eed91b
            64=9daab9e2
            66=e944b576,09ec5b5b
            68=1e2e9525,85b8711d
            69=519c4a94,18c48e24,8089bd5b
            70=464418d4
            71=f59e453b
            73=e7e9e58b,4d46954e,09ec5b5b
            75=1e2e9525,85b8711d
            76=519c4a94,65fed3d8
            77=d86789c1,c03adbf1
            78=e8abf2cc,6132f953
            79=4a3a6437,1d0ec63f
            80=961dfaa7
            81=88805158,413325d7,9d0a82fa,2715bb0e
            83=459e6ad4,8d4e7642
            84=3746bff1
            85=0293b704,e5d56bac,a4ada2fd
            86=fb10d563,e158cdb1
            87=4c54b951,dffe695b
            90=868d4d34,2031e5cc,fab79c22
            91=49754210,75c8c3a2
            94=d4f9c2cf,1e035e8c
            97=0b6589d1,3f5a04e8,ff3a0280
            100=847627e2,308b3a5b
            101=87eb119e
            102=a83f8a22
            103=9641afec
            106=c95fb1b1,18ee73d3
            107=2e03d45a,87eb119e,365a6794
            108=0b7da30f
            109=63cde0e4,2be61d91,c95fb1b1
            110=114d09d2
            112=7a48523d,7115bf81
            113=b5ee6564,b1de8d55
            115=6acd7f03,214ef97e,7f260a40
            116=59c1c016,74a954f8
            117=2c89593a,7f46ecf0
            118=2e3a07bf,87f2a81f
            119=e106d187,7a534d67
            120=f0ee62b1,2201f7a1
            123=d3ffcd2d,37d5a047
            124=8739f582
            125=7c7eb915,69232603
            126=263d8c6d
            127=8e789e91,51d5f695,66be4909
            128=af50e92f
            130=a45daefd
            131=5e7a2cb7,3ef85c88
            132=052ff589
            133=7fa59123
            134=4f6b9e7a,e0828558,89c2f58e
            135=b6c0ec4e
            136=a65c75c1,895a98a4
            139=d2ad211e,8c145b15
            140=08b6afb1
            141=475f127b,5ee108a6
            143=65cb6303
            144=efcc7681,2205d383,ff5dfccd,17609495
            146=57b9fa12
            147=a6ecc461,396fcc7e,22ba3918
            148=e91d2c20
            149=485a7102,505a3c9b,a5e0ae3b
            151=161f0f33,b5609d22,c28cfd88
            153=dbb3d3eb
            154=3ecbfcdc
            155=8bb06c37,e24b9112,d84c0611
            156=fcfb88a6
            157=cf4eda1e,769eb0a3,5743ecc8
            158=986b4ce7
            159=6d717d98,761da93f,d2c51d9d
            161=5e153bd1,e0d6f354,6a77b096
            162=b93373f6,767707a3
            163=d9d542cd
            165=0fd68808,f7e266d8
            167=c723e5df
            168=b0de22c2,a1a1527c
            169=e46356e3,44c2f10a,fe79d01e,97281b1d
            171=38dfdc96,b23c851e,3049cb0a,44d62a74,e99d13ed
            172=adb77f40,6b56e70e
            173=c324ee9c
            174=74544c0c
            176=c0571d2a
            178=dbc9bd6f,a1108271
            180=3017532e
            181=cdd249e9
            182=708e7097,96570df0
            183=7ac2159e
            184=40cd3f42,c453dac3
            185=80c8be5e,2564c555
            186=58537bf5,a556181e
            187=f8726ff7
            189=096d9c95,b353c2c1
            191=d1e03b12
            192=fb0d20c4
            193=028ead5a,cab55853,d7aead00
            195=93951dcd
            197=ff5dfccd,064b3e26
            199=d3f942b8,8fe9d4f5,2a9536b0
            200=abbf89cb,579ca428

        """.trimIndent()
    }

    "The fingerprint should be calculated correctly for the CC-BY-3.0 license text" {
        wfpForResource("/wfp/CC-BY-3.0.license") shouldBe """
            file=6dffb34dbf23fffe10cc646d9c030e14,19467,CC-BY-3.0.license
            5=996e9d8b,1a6dc238
            6=70a3753f,14d9bf35,0dbf4b11,d58971b7,86fbc9f3
            8=38a05276,065a11d9
            9=40be60c9
            12=209acf93
            14=7c3a24a3
            15=c38cf970,466ca7dc
            16=919511d3,8a9102e8,40b284be,d9266ff1,805b32ad
            19=86eacf9b,c81b73e2
            20=1e033450,5795e718,5aca67b8
            22=3fd2e8a4,343551a3,64b16514,e3f1b701
            27=a76c7c2d
            28=bd096f88,5e546ea2
            29=1437d5f9,325cf2e3
            30=a733b3e5,25af8372
            31=be495901
            32=3c339748,4f4653d0
            33=6fa5686e,8645a350
            34=f860eb15,8b9b1694,d893b55f
            36=77a04aee,c8127973
            37=69082aaf,a6e7784d
            38=6e81d7a2,d893b55f
            39=e16ee1b1
            40=ba81dae3,43e4637c
            41=04e45076
            42=311db27a,73be7e0f
            43=0a4ed7ad,d3fd5534
            44=7e0fd8c0,cca26f8e
            45=2fd3017e
            46=16e05ee5,47fade55
            47=ce09763d,ff2a6946
            48=8b9b1694,423df531
            50=f2718c09
            51=889fc712,71405538
            53=37b1c352,caac3e6a,c616211c,341fa48a
            54=cdee6dd5
            55=315930af,8741ac46
            57=341fa48a,cea2ca24
            58=343016f4,be498bd4
            60=854cc811,6153e6d2,71d402b5,bbcc9383,b132c5be
            61=bdcf408f
            62=6e2805d2
            63=e6a59edd,af9d954a,cc21cbf4,9397cfc1
            64=be52a47c
            65=2971bc06
            66=f2d04fa4,d362e8e2
            67=6a383757
            68=2c1eb7a2,e6076e1d,4d95288f
            69=4416e808
            70=a0f7c877
            71=d6531bb9
            72=a0b8ea06,e0b0c0ed
            73=589ba8bb
            75=9923bbfe,b76d2c92,78daf969
            76=2b9583f1
            77=5b224371
            78=548057a9,56f711d8,575d37e2
            79=65cf1e0b
            80=cf287ae2
            81=eeab16c0,bb39b03f,c158f555,89894fe3
            82=ee951a68
            83=4e2d65ef
            84=04223a61
            85=98df7fd7,889d0fca
            86=1aa726dd,8196acca,7732fb2e
            88=25b4c65c,438ff750,13226cc8
            90=2a6d52d6,1536466a,4cd9d222
            91=0e17a9b4
            92=f8d4430e,8e2b9262,337ee49e
            93=d8d0241d
            94=ccf7fcd4
            95=27d161a1,d82c7466,eaf25271
            96=e82e47bb
            98=1d3562d1
            99=0f2de545,2ed05c37,cc4fa387
            100=d7b89c5a,9651375c
            101=8e9d2f99,3857dc7d
            102=e5ec2f61
            104=fd0e0a0a
            105=71097e12,86031b43
            106=86f7b777
            107=8b339abb,767f1ccc
            109=09ec5b5b
            110=4a75259d
            111=5b540506,2f330cd6
            112=1e8baa7a
            114=8ca02d83,d181a2ee
            115=9cce42a1
            117=86a1a220,26c8f4ce
            118=e9bb38f0,6c3b792d
            119=80245504,b7c4275d
            120=e512cb20
            122=7b877508,b7d64ff2
            123=7f7faa51,3c8a15d6,b945dac8
            125=3a6885fa
            128=595d9c7d,b1c3131a,b1054311
            130=176b4d65
            131=552322c3
            132=39d3391c,d3c119e3,6dba98be
            133=3612d955,b1054311
            135=176b4d65,cfc872a6,e1f534e6
            137=6dba98be
            138=69f8020d
            139=8110b212
            140=ac47da61,58d0d53e
            142=3f7323d4,dc6e88e2,3612d955
            144=23847681
            145=a81007f6,6c109f94
            146=db901615
            147=a190783a,469aeb91
            150=7af883f2,81742c47
            151=30b7f89d
            153=6a258a8d,6d79dbfb,2b667545
            154=bd96fe24,bf50ef4b
            156=874b2db0,53a48725,0a36b9f1
            157=7db83c86,61311f6a
            158=53159e1d,463f1815
            160=96fc5a94,e7a6c096
            161=e1407d9a,afc0b125,8cf1412a,6edf7576
            162=53a48725
            163=990299a3
            164=ffbcb502,72b6eee7
            165=4a3b96da,926c873e,463f1815
            166=96fc5a94
            167=91937c8e
            168=74dcd511
            169=f75176d3,c7c9d5e4,422c8308,ec7707d2
            170=ecb75d36
            172=fbdf710e
            173=1838c008
            174=280c0db6,efed2463
            175=2b9ae0e2
            176=cc0d7f48
            177=c07bb49f,eba7bf30
            178=621cba11
            179=a3389cbf
            180=b25341c0,c3c6b3c1
            181=ca375f87,e79f8103
            182=bd59471e,ad31744a
            183=21542008
            184=62e0f9b9
            185=17756753,1a8e5ecd
            187=ad71497e
            188=3b7d49b7,0f7cedec,32551f09
            190=2b75c595,d74f5df2,e49a28fc
            191=54c31657
            192=89456130
            193=e299a9b1,b483acc3
            194=d3751394
            195=9220c7d5,5f22cc60,ab9d29f4
            196=656ea59e
            197=18e4e674,20c125a0
            199=5c0e6186
            200=333fbfdf,e90be40d
            201=4358912a
            202=44779d50,65aa76d8
            203=3cc50754
            205=97ba92f3,88978d3b
            206=fcb49efa,0ae679c9,78299c2c
            207=2e19de94,c236b6be
            208=5db5515f
            209=cc0d7f48
            210=168ba04d,3746c6a4
            211=d3701d39,19b53075
            212=6ee318eb,9badb5d4,1bbd31d5
            213=b5058d7f
            214=38a53b6c
            215=c5d90cde
            216=a7630a58
            217=d3cf1631,80085603,5e287c2d
            218=fdafa926
            219=6b19f33f
            220=d9e8eacd,ad4c22f9
            224=899e2509,5b166640
            225=de7b5976
            226=4aef1372,06df53b1,f45611af
            227=6bd3b904,a698df65
            228=e284984a,d29facaa
            229=a2917cc1,52caa4e1,445f6090
            230=9f83005f,cc043ccf,d39c8033
            231=e33f8a80,ad16bc58
            234=f13448ee,a3b2393e
            235=e60b5450
            236=8116203f,edb253ba
            237=0bc3223d
            239=2a65df10,b3214933
            241=0bc1f684
            242=47ab5082,7324b121,2439b300
            243=af0be73d
            244=55af4b2b,d284dcc1,c316abc4,5d0233ec
            245=43dc755c
            246=69eb4bf0,35aab8a1
            248=cdaf5893,ad730d35,d380d0d0,ef5d7c8c
            249=965063b4,adb6a6e6
            250=63d3be03,f987694f,46317da9
            251=86de27f3
            252=b9402f7f,2738bc91,80ecbcba
            254=bd105c74,53238d58
            255=4ef2cc2d,e4dd3a43,e9368d53,8ef1a17d
            260=edff6af2
            261=2b667545,b704d0d4,f6121499
            262=0aa0b189
            263=f505f5b7,98f19e72
            264=9607fe02
            265=d0e120ca
            266=75a37628,539c9984
            267=63bb8001,d056a503
            268=82c4bda0,db23ee3b
            269=a794639c
            270=90b2477b
            272=1d7a9b2b
            273=cb585c7c,d337b261
            274=3bacf32d
            275=3c85e934
            276=3e9d915f
            277=407e50ab,100b3e9c
            278=d919c919,41f7f6c9
            279=ffe655c1
            280=bb75b62b
            281=fd8c0eda,80aed826
            282=9d2a4ec0,fc329cad
            283=3c9dec21,0837ec68
            284=e617b189
            285=297feecf
            286=70c176ac,73da16c5
            287=7bc01c8f,f6603bb6,2ee66c0e,25e6770b
            288=762ae77c
            289=cf2c5941,ef58f204
            290=957fe931,573c80e6
            292=798fd442,4b8de504,7719c7c5
            293=791f94a8,13eee247,1ecbd858
            294=12768726
            298=0d58979d
            300=7a01f934,01bf219a,44c62e84,4f021f05
            302=aee2f91d,9c543eee
            303=45466d3c,b5bb169a
            304=a288071d
            305=4c51082e
            306=27116cb3
            307=e33456c6
            309=8846fe22,adfed4fe,8f5562d9,9f621163
            310=4179947d
            311=09153697
            312=db17de6c
            313=67511552,28cf7201,abaa6931
            314=e590f3ed
            315=37d4e6f9,7a9ff9f5
            316=541c72ce
            317=2c82086e,9b8228d3
            319=2d3b840b,cb841dec

        """.trimIndent()
    }

    "The fingerprint should be calculated correctly for the Winnowing paper" {
        // Note that the ".pdf" file extension is hard-coded to be skipped for snippet calculation.
        wfpForResource("/wfp/sigmod03.pdf", binFile = true) shouldBe """
            file=232512a681d2488f61ade07516f899b5,155473,sigmod03.pdf

        """.trimIndent()
    }
})
